function buildTools(){DB.once("value",function(a){var b=new Object,c=Object.keys(a.val()).length,d=!0;if(a.forEach(function(a){if(null!=a.val().positions&&null!=a.val().positions[uid]){var e=c-a.val().positions[uid];b[e]=a.key}else d=!1}),d)for(i in b){var e=b[i],f=a.val()[e].heName,g=a.val()[e].backgroundColor;null!=f&&buildTool(f,e,g)}else a.forEach(function(a){null!=a.val().heName&&buildTool(a.val().heName,a.key,a.val().backgroundColor)});DB.on("child_removed",function(a){$("#"+a.key).remove()}),setSortable(),startScreen()})}function buildTool(a,b,c){$("#sortable").prepend('<div id="'+b+'" class="accordion"><h3 id="header'+b+'" style="background:'+c+'">'+a+'</h3><div class="accordionContent"><input type=text id="'+b+'Input" placeholder="הוסף/י סיבות לחשיבות הכלי"><input type="button" value="אישור" onclick=setReason("'+b+'")><table id="'+b+'Reasons" class="reasons"></table></div> </div>')}function setReason(a){var b=$("#"+a+"Input").val();null!=b&&""!=b&&(DB.child(a+"/reasons").push({reasonText:b,votes:0,creator:uid,color:"gray"}),$("#"+a+"Input").val(""))}function deleteReason(a,b){DB.child(a+"/reasons/"+b).once("value",function(c){if(null!=c){var d=c.val().creator;if(d!=uid)return void alert("רק מי שיצר את הסיבה, יכול למחוק אותה");DB.child(a+"/reasons/"+b).remove()}})}function startScreen(){DB.once("value",function(a){a.forEach(function(a){DB.child(a.key+"/reasons").orderByChild("votes").on("child_added",function(b){DB.child(a.key).child("reasons/"+b.key+"/votes").on("value",function(c){var d=c.val();$("#"+b.key).attr("data-sort",d),DB.child(a.key+"/reasons").orderByChild("votes").once("value",function(b){$("#"+a.key+"Reasons").html(""),b.forEach(function(b){if(void 0!=b.val().reasonText&&$("#"+a.key+"Reasons").prepend("<tr class='reason' id='"+b.key+"' data-sort='"+b.val().votes+"'><td><img src='x.png' width='13px' align='middle' onclick=deleteReason('"+a.key+"','"+b.key+"')></td><td><div class='reasonText'>"+b.val().reasonText+"</div></td><td><td class='votes' id='yes"+a.key+b.key+"' onclick=setVote('yes','"+a.key+"','"+b.key+"')>כן</td><td class='votes' id='abs"+a.key+b.key+"' onclick=setVote('abs','"+a.key+"','"+b.key+"')>נמנע</td><td class='votes' id='no"+a.key+b.key+"' onclick=setVote('no','"+a.key+"','"+b.key+"')>לא</td></td></tr>"),null!=b.val().voters){var c=b.val().voters[uid];switch(c){case 1:$("#yes"+a.key+b.key).css("color","green"),$("#abs"+a.key+b.key).css("color","lightgray"),$("#no"+a.key+b.key).css("color","lightgray");break;case 0:$("#yes"+a.key+b.key).css("color","lightgray"),$("#abs"+a.key+b.key).css("color","green"),$("#no"+a.key+b.key).css("color","lightgray");break;case-1:$("#yes"+a.key+b.key).css("color","lightgray"),$("#abs"+a.key+b.key).css("color","lightgray"),$("#no"+a.key+b.key).css("color","green")}}})})})}),DB.child(a.key+"/positions").on("value",function(b){if(null!=b){var c=0;b.forEach(function(b){c+=parseInt(b.val()),uid==b.key&&(g_userToolsPosition[a.key]=parseInt(b.val()))}),DB.child(a.key).update({position:c}),g_toolsArray[a.key]=c}})})})}function showGroupPositions(){DB.orderByChild("position").on("value",function(a){var b=new Object,c=new Object,d=0,e=0;$("#groupSortTools").html("");var f;a.forEach(function(d){var g=d.val().heName,h=d.val().backgroundColor;f=Object.keys(a.val()).length,b[d.key]=e,null!=d.val().positions&&null!=d.val().positions[uid]&&(c[d.key]=d.val().positions[uid],$("#groupSortTools").append("<div class='groupTools' style='background:"+h+"'>"+g+"</div>"),e++)});for(e in b){var g=Math.abs(b[e]-c[e]),h=f-g,i=h/Math.pow(f,2);d+=i}var j=2*(1-d);d=Math.round(1e3*(1-j))/1e3,$("#diff").text(d);var k=levelOfAgreementColor(d);$("#groupMatchBar").css("height",100*d+"%").css("background",k)})}function setVote(a,b,c){var d=0;switch(a){case"yes":"rgb(0, 128, 0)"!=$("#yes"+b+c).css("color")&&($("#yes"+b+c).css("color","green"),$("#abs"+b+c).css("color","gray"),$("#no"+b+c).css("color","gray"),d=1);break;case"no":"rgb(0, 128, 0)"!=$("#no"+b+c).css("color")&&($("#yes"+b+c).css("color","gray"),$("#abs"+b+c).css("color","gray"),$("#no"+b+c).css("color","green"),d=-1);break;case"abs":"rgb(0, 128, 0)"!=$("#abs"+b+c).css("color")&&($("#yes"+b+c).css("color","gray"),$("#abs"+b+c).css("color","green"),$("#no"+b+c).css("color","gray"),d=0)}DB.child(b+"/reasons/"+c+"/voters/"+uid).set(d),DB.child(b+"/reasons/"+c+"/voters").once("value",function(a){var d=0;a.forEach(function(a){d+=a.val()}),DB.child(b+"/reasons/"+c+"/votes").set(d)})}function setTool(a,b){DB.child(b).set({heName:a,backgroundColor:"gray",reasons:{placeholder:"placeholder"}})}function orderObject(a){var b=new Array;for(i in a)b.push([a[i],i]);b.sort();var c=new Object;for(i in b)c[b[i][1]]=i;return c}function comparePesonalNGroups(a,b){var c=0,d=Object.keys(a).length,e=orderObject(b);for(i in a)toolDiff=Math.abs(a[i]-e[i]),c+=(d-toolDiff)/Math.pow(d,2);return c}function levelOfAgreementColor(a){return a>.9?"green":a>.8?"lightgreen":a>.7?"yellow":a>.6?"orange":a<=.6?"red":void 0}function setSorting(){"הפסקת סידור"==$("#buttonSort").html()?($("#buttonSort").html("סידור כלים"),$("#sortable").sortable("destroy")):($("#buttonSort").html("הפסקת סידור"),$("#sortable").sortable())}function deleteAllReasons(){DB.once("value",function(a){a.forEach(function(a){DB.child(a.key).child("reasons").once("value",function(b){b.forEach(function(b){"placeholder"!=b.val()&&DB.child(a.key).child("reasons").child(b.key).remove()})})})})}function deleteAllPositions(){DB.once("value",function(a){a.forEach(function(a){DB.child(a.key).child("positions").once("value",function(b){b.forEach(function(b){"placeholder"!=b.val()&&DB.child(a.key).child("positions").child(b.key).remove()})})})})}function newGame(){var a=confirm("האם אתה בטוח שאתה רוצה למחוק את המשחק הקודם?");a&&(deleteAllPositions(),deleteAllReasons())}var DB=firebase.database().ref();buildTools(),g_toolsArray=new Object,g_userToolsPosition=new Object,showGroupPositions();
